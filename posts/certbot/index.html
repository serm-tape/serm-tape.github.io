<!doctype html><html prefix="og: https://ogp.me/ns#" lang data-theme=light><head><meta charset=utf-8><title>https ด้วย certbot บน express - Serm's blog</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title itemprop=name>https ด้วย certbot บน express |</title><meta property="og:title" content="https ด้วย certbot บน express | "><meta name=twitter:title content="https ด้วย certbot บน express | "><meta itemprop=name content="https ด้วย certbot บน express | "><meta name=application-name content="https ด้วย certbot บน express | "><meta property="og:site_name" content><meta name=description content="จดไว้ กันลืม หลังๆนี่ได้ทำบ่อย"><meta itemprop=description content="จดไว้ กันลืม หลังๆนี่ได้ทำบ่อย"><meta property="og:description" content="จดไว้ กันลืม หลังๆนี่ได้ทำบ่อย"><meta name=twitter:description content="จดไว้ กันลืม หลังๆนี่ได้ทำบ่อย"><base href=https://blog.sermtape.com/posts/certbot/><link rel=canonical href=https://blog.sermtape.com/posts/certbot/ itemprop=url><meta name=url content="https://blog.sermtape.com/posts/certbot/"><meta name=twitter:url content="https://blog.sermtape.com/posts/certbot/"><meta property="og:url" content="https://blog.sermtape.com/posts/certbot/"><meta property="og:locale" content="en"><meta name=language content><meta itemprop=image content="https://blog.sermtape.com/images/certbot.svg"><meta property="og:image" content="https://blog.sermtape.com/images/certbot.svg"><meta name=twitter:image content="https://blog.sermtape.com/images/certbot.svg"><meta name=twitter:image:src content="https://blog.sermtape.com/images/certbot.svg"><meta property="og:updated_time" content="2019-09-08T17:30:00+0700"><link rel=sitemap type=application/xml title=Sitemap href=https://blog.sermtape.com/sitemap.xml><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content><meta name=twitter:creator content><link rel="shortcut icon" href=/favicon.ico><link rel=icon type=image/x-icon sizes="16x16 32x32" href=/favicon.ico><meta name=color-scheme content="light, dark"><link rel=author href=https://blog.sermtape.com/humans.txt><script>const storage=localStorage.getItem("dark-mode");("dark"===storage||!storage&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.documentElement.setAttribute("data-theme","dark")</script><script src=https://blog.sermtape.com/js/darkm.min.d20a2fbdf4f91c190693010da1bdbb6780b2ad0bfd40228d9311589e3882e136.js></script>
<link rel=stylesheet href=https://blog.sermtape.com/css/style.min.a381a86ce2ec85350be79d05e6ba9c8078fe624cee9d6883a12fdb9499ab0f01.css></head><body class=page><header class=site-header><div class=inner><p class="site-title slide-horizontal-invert"><a href=/>Serm's blog</a></p><input type=checkbox id=check-menu class=check-menu hidden>
<label for=check-menu class="nav-btn hide-desktop" aria-label="Open/close menu"><span class=lines></span></label><nav class="site-nav hide-mobile slide-horizontal"><svg style="display:none"><symbol viewBox="0 0 24 24" id="moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></symbol><symbol viewBox="0 0 24 24" id="sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></symbol></svg><button class="theme__btn light--hidden" aria-label="Enable light mode"><svg aria-hidden="true"><use href="#sun"/></svg></button>
<button class="theme__btn dark--hidden" aria-label="Enable dark mode"><svg aria-hidden="true"><use href="#moon"/></svg></button><ul class=site-menu><li><a href=/about/me><span>about me</span></a></li><li><a href=/posts><span>Archives</span></a></li></ul></nav></div></header><main class=site-main><article><header class=subheader style=background-image:url(/images/certbot.svg)><div class="title-container slide-invert"><h1 class=post-title>https ด้วย certbot บน express</h1></div></header><div class="content slide-invert"><p><img src=/images/certbot.svg alt=certbot></p><h1 id=https-ดวย-certbot-บน-express>HTTPS ด้วย certbot บน express</h1><p>พอดีว่าพักหลังๆได้เซทเซิฟเวอร์แล้วต้องทำ https พอจะมาทำอีกรอบก็ลืมไปแล้วว่าต้องทำอะไรบ้าง เลยจัดไว้ในนี้เลยละกัน เผื่อลืม</p><h2 id=install-certbot>install certbot</h2><p>ก่อนจะทำการสร้าง certificate ก็ต้องดาวน์โหลด certbot มาใช้ก่อน เพื่อเป็น Agent ในการยืนยันโดเมนและเซิฟเวอร์ของเรา
ติดตั้ง epel (extra packages for enterprise linux), yum-utils และสุดท้าย พระเอกของเรา certbot</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ yum install epel-release
</span></span><span style=display:flex><span>~$ yum install yum-utils
</span></span><span style=display:flex><span>~$ yum install certbot
</span></span></code></pre></div><h2 id=แลวเวบเซฟเวอรเราละ>แล้วเว็บเซิฟเวอร์เราล่ะ</h2><p>ด้วย ACME protocol ที่ agent ตัวนี้ใช้นั้น ต้องใช้ http server ในการยืนยันด้วย แน่นอนว่า certbot เองก็รู้ดีว่าเราขี้เกียจกันขนาดไหน เพียงแค่เรารันด้วย <code>--standalone</code> โหมด http server ก็จะถูกเปิดขึ้นใช้เฉพาะกิจเพื่อการยืนยันโดยเฉพาะ จากนั้นก็กรอกรายละเอียดสำหรับ Public key ของเรา เป็นอันเสร็จสิ้น</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ certbot certonly --standalone
</span></span></code></pre></div><p>แต่ถ้ามีเซอร์วิสรันที่พอร์ท 80 อยู่แล้วก็ต้องปิดไปก่อน เพราะบอทของเราจะใช้ แต่ถ้าปิดไม่ได้จริงๆก็ให้ใช้แบบ webroot ยืนยันแทน ก็คือให้ยืนยันผ่านทาง static path ของเราที่สร้างขึ้นนั่นเอง</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ certbot certonly --webroot ./well-known/acme
</span></span></code></pre></div><h2 id=รนแลวไปไหน>รันแล้วไปไหน</h2><p>หลังจาก certbot ทำการยืนยันโดเมนและเซิฟเวอร์เราเรียบร้อยแล้ว cert จะกองอยู่ที่ <code>/etc/letsencrypt/live/${domain}/</code> โดยเราจะใช้ <code>fullchain.pem</code> กับ <code>privkey.pem</code> ไปใส่ใน app ของเรา จะใช้ link หรืออะไรก็แล้วแต่สะดวกเรา</p><h2 id=express-โลด>express โลด</h2><p>เอา path <code>privkey</code> <code>fullchain</code> ของเราไปใส่ในคอนฟิกของ express server ก็เป็นอันเสร็จสิ้น</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>privateKey</span>  <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFileSync</span>(<span style=color:#a6e22e>API_CONFIG</span>.<span style=color:#a6e22e>ssl_key</span>, <span style=color:#e6db74>&#39;utf8&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>certificate</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFileSync</span>(<span style=color:#a6e22e>API_CONFIG</span>.<span style=color:#a6e22e>ssl_cert</span>, <span style=color:#e6db74>&#39;utf8&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>credentials</span> <span style=color:#f92672>=</span> {<span style=color:#a6e22e>key</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>privateKey</span>, <span style=color:#a6e22e>cert</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>certificate</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>httpsServer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>https</span>.<span style=color:#a6e22e>createServer</span>(<span style=color:#a6e22e>credentials</span>, <span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>httpsServer</span>.<span style=color:#a6e22e>listen</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>API_CONFIG</span>.<span style=color:#a6e22e>port_https</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>API_CONFIG</span>.<span style=color:#a6e22e>listen_host</span>,
</span></span><span style=display:flex><span>    () =&gt; <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`https listen on port </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>API_CONFIG</span>.<span style=color:#a6e22e>port_https</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h2 id=เหมอนจะเสรจ-แตยงไมเสรจ>เหมือนจะเสร็จ แต่ยังไม่เสร็จ</h2><p>cert ตัวนี้อายุสั้นเพียงสามเดือน เพราะฉะนั้นต้องคอยรีนิวเรื่อยๆ ก็ใช้ <code>certbot renew</code> แล้วใส่ cron แบบมักง่ายก็ได้</p><h2 id=อางอง>อ้างอิง</h2><ul><li><a href=https://certbot.eff.org/lets-encrypt/centosrhel7-other>certbot</a></li><li><a href=https://letsencrypt.org/how-it-works/>how it works</a>
และ stack overflow อีกหลายมู้ที่จำไม่ได้แล้ว</li></ul></div></article></main><footer class=site-footer><p class=copyright>© 2022 Serm's blog</p><ul class=social-links><li><a class='icon icon-github' href=https://github.com/serm-tape aria-label="Follow on GitHub"></a></li><li><a class='icon icon-linkedin' href=https://www.linkedin.com/in/sermsak-tummarattanarangsee-602b83aa aria-label="Follow on LinkedIn"></a></li></ul></footer><script src=/js/prefixfree.min.c3db0d4d275151e7b045bcc28430e293595ec5a2d8435d810b9a00984ef6f792.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5P0CZ94PV8"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-5P0CZ94PV8")</script></body></html>